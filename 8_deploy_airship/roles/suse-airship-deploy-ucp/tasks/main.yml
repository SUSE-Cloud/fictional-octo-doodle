---
# tasks file for suse-airship-deploy
- name: Load standard variables
  include_vars: "{{ playbook_dir }}/../vars/common-vars.yml"

- set_fact:
    site_path: "{{ suse_airship_deploy_home }}/sites/{{ suse_airship_deploy_site_name }}"

- name: Create site manifest directory
  file:
    path: '{{ site_path }}/{{ item.path }}'
    state: directory
  with_filetree: '{{ role_path }}/templates/sites/{{ suse_airship_deploy_site_name }}'
  when: item.state == 'directory'
  tags:
    - install

#TODO JG refactor overrides
- name: Create site manifest yamls
  template:
    src: '{{ item.src }}'
    dest: '{{ site_path }}/{{ item.path }}'
  with_filetree: '{{ role_path }}/templates/sites/{{ suse_airship_deploy_site_name }}'
  when: item.state == 'file'
  tags:
    - install

- name: Build Armada image
  make:
    chdir: "{{ upstream_repos_clone_folder }}/airship-armada"
    target: images
  when: _gitclone is changed
  tags:
    - install

- name: Build Shipyard and Deckhand charts
  make:
    chdir: "{{ upstream_repos_clone_folder }}/{{ item.repo_name }}"
    target: "{{ item.target }}"
    params:
      DISTRO: "{{ suse_distro_identifier }}"
      DISTRO_BASE_IMAGE: "{{ suse_airship_components_base_image }}"
      IMAGE_TAG: "{{ suse_airship_components_image_tag }}"
      IMAGE_NAME: "{{ item.image_name }}"
#  when: _gitclone is changed
  loop:
    - { repo_name: "airship-shipyard", target: "images", image_name: "airflow" }
    - { repo_name: "airship-shipyard", target: "images", image_name: "shipyard" }
    - { repo_name: "airship-deckhand", target: "images", image_name: "deckhand" }
  tags:
    - install

- name: Create Armada cluster role binding yaml
  template:
    src: ./armada-cluster-role-binding.yaml.j2
    dest: "{{ suse_airship_deploy_config_location }}/armada-cluster-role-binding.yaml"
  tags:
    - install

- name: Apply Armada cluster role binding
  shell: "kubectl apply -f {{ suse_airship_deploy_config_location }}/armada-cluster-role-binding.yaml"
  tags:
    - install

- name: Create Armada deployment yaml
  template:
    src: ./armada.yaml.j2
    dest: "{{ suse_airship_deploy_config_location }}/armada.yaml"
  tags:
    - install

- name: Deploy Armada pod to CaaSP
  shell: "kubectl apply -f {{ suse_airship_deploy_config_location }}/armada.yaml"
  tags:
    - install

- name: Get Armada pod name
  shell: 'kubectl get pod -l app=armada -n {{ ucp_namespace_name }} -o jsonpath="{.items[0].metadata.name}"'
  register: armada_results
  until: armada_results.stdout.find('armada-') == 0
  retries: 60
  delay: 10
  ignore_errors: yes

- set_fact: armada_pod_name={{ armada_results.stdout }}

- debug:
    msg: "Armada pod found: {{ armada_pod_name }}"

    #checking ready appears to be sufficient JG
    #- name: Wait until Armada pod is running
    #  shell: "kubectl get pod {{ armada_pod_name }} -n {{ ucp_namespace_name }} -o jsonpath='{.status.phase}'"
    #  register: armada_pod_status
    #  until: armada_pod_status.stdout_lines == "Running"
    #  retries: 60
    #  delay: 15
    #  ignore_errors: yes

- name: Wait until Armada pod is ready
  shell: "kubectl get pod {{ armada_pod_name }} -n {{ ucp_namespace_name }} -o jsonpath='{.status.containerStatuses[].ready}'"
  register: armada_pod_status
  until: armada_pod_status.stdout == "true"
  retries: 30
  delay: 10
  ignore_errors: yes

- file:
    path: "{{ suse_airship_deploy_config_location }}/manifests"
    state: directory
  tags:
    - install

- name: Create airship ucp manifest
  template:
    src: ./airship.yaml.j2
    dest: "{{ suse_airship_deploy_config_location }}/manifests/airship.yaml"
  tags:
    - install

- name: Copy Airship UCP content to Armada pod
  command: "{{ item }}"
  loop:
    - kubectl exec {{ armada_pod_name }} -n ucp -- mkdir -p /armada
    - kubectl exec {{ armada_pod_name }} -n ucp -- mkdir -p /armada/.kube
    - kubectl cp ~/.kube/config ucp/{{ armada_pod_name }}:/armada/.kube/config
    - kubectl cp  {{ suse_airship_deploy_config_location }}/manifests ucp/{{ armada_pod_name }}:/armada
    - kubectl exec {{ armada_pod_name }} -n ucp -- mkdir -p /armada/airship-components
    - kubectl cp {{ upstream_repos_clone_folder }}/airship-armada ucp/{{ armada_pod_name }}:/armada/airship-components/
    - kubectl cp {{ upstream_repos_clone_folder }}/airship-deckhand ucp/{{ armada_pod_name }}:/armada/airship-components/
    - kubectl cp {{ upstream_repos_clone_folder }}/airship-pegleg ucp/{{ armada_pod_name }}:/armada/airship-components/
    - kubectl cp {{ upstream_repos_clone_folder }}/airship-shipyard ucp/{{ armada_pod_name }}:/armada/airship-components/
    - kubectl cp {{ upstream_repos_clone_folder }}/openstack-helm ucp/{{ armada_pod_name }}:/armada/airship-components/
    - kubectl cp {{ upstream_repos_clone_folder }}/openstack-helm-infra ucp/{{ armada_pod_name }}:/armada/airship-components/
  tags:
    - install

#TODO JG check if ucp deployment is ready
- name: Deploy Airship UCP ... time for a quick coffee
  shell: 'kubectl exec {{ armada_pod_name }} -n ucp -- armada apply /armada/manifests/airship.yaml'
  tags:
    - install

- name: Wait until Armada api pod is deployed
  shell: 'kubectl get pod -l application=armada,component=api -n {{ ucp_namespace_name }} -o jsonpath="{.items[0].metadata.name}"'
  register: armada_results
  until: armada_results.stdout.find('armada-api-') == 0
  retries: 180
  delay: 10
  ignore_errors: yes

- set_fact: armada_api_pod_name={{ armada_results.stdout }}

- debug:
    msg: "armada-api pod found: {{ armada_api_pod_name }}"

- name: Wait until Airship api becomes ready
  shell: "kubectl get pod {{ armada_api_pod_name }} -n {{ ucp_namespace_name }} -o jsonpath='{.status.containerStatuses[].ready}'"
  register: armada_api_pod_status
  until: armada_api_pod_status.stdout == "true"
  retries: 60
  delay: 10
  ignore_errors: yes

- name: Copy customer site data to treasuremap repo
  copy:
    src: "{{ suse_airship_deploy_home }}/sites/{{ suse_airship_deploy_site_name }}"
    dest: "{{ upstream_repos_clone_folder }}/airship-treasuremap/site/"

- name: Run overcloud deployment now
  shell: ./tools/deployment/airskiff/developer/100-deploy-osh.sh
  args:
    executable: /bin/bash
    chdir: "{{ upstream_repos_clone_folder }}/airship-treasuremap"
  environment:
    PL_SITE: "{{ suse_airship_deploy_site_name }}"
  register: overcloud_deploy_result

- debug:
    msg: "Overcloud deployment result = {{ overcloud_deploy_result }}"
